name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allows maintainers to manually trigger

env:
  PULUMI_STACK: prod
  PULUMI_ORG: zacdirect
  PULUMI_USER: user:zacdirect
  PULUMI_TOKEN: urn:pulumi:token-type:access_token:personal

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      compute: ${{ steps.filter.outputs.compute }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            compute:
              - 'infra/compute/**'

  infra-compute:
    name: IaC Compute
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.compute == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Pulumi Preview (Compute)
        uses: ./.github/actions/pulumi
        with:
          stack-name: ${{ env.PULUMI_STACK }}
          organization: ${{ env.PULUMI_ORG }}
          requested-token-type: ${{ env.PULUMI_TOKEN }}
          scope: ${{ env.PULUMI_USER }}
          command: preview
          work-dir: ./infra/compute

  infra-publishing:
    name: IaC Publishing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Pulumi Preview (Publishing)
        uses: ./.github/actions/pulumi
        with:
          stack-name: ${{ env.PULUMI_STACK }}
          organization: ${{ env.PULUMI_ORG }}
          requested-token-type: ${{ env.PULUMI_TOKEN }}
          scope: ${{ env.PULUMI_USER }}
          command: preview
          work-dir: ./infra/publishing

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [infra-compute, infra-publishing]
    if: ${{ always() && !failure() && !cancelled() }}
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Pulumi Up (Compute)
        id: pulumi-compute
        if: ${{ needs.infra-compute.result == 'success' }}
        uses: ./.github/actions/pulumi
        with:
          stack-name: ${{ env.PULUMI_STACK }}
          organization: ${{ env.PULUMI_ORG }}
          requested-token-type: ${{ env.PULUMI_TOKEN }}
          scope: ${{ env.PULUMI_USER }}
          command: up
          work-dir: ./infra/compute

      - name: Pulumi Up (Publishing)
        id: pulumi-publishing
        uses: ./.github/actions/pulumi
        with:
          stack-name: ${{ env.PULUMI_STACK }}
          organization: ${{ env.PULUMI_ORG }}
          requested-token-type: ${{ env.PULUMI_TOKEN }}
          scope: ${{ env.PULUMI_USER }}
          command: up
          work-dir: ./infra/publishing

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Deploy Azure Function (only if compute ran)
      - name: Setup Node.js for Function
        if: ${{ needs.infra-compute.result == 'success' }}
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Function Dependencies
        if: ${{ needs.infra-compute.result == 'success' }}
        working-directory: ./infra/compute/function
        run: npm ci

      - name: Build Function
        if: ${{ needs.infra-compute.result == 'success' }}
        working-directory: ./infra/compute/function
        run: npm run build

      - name: Deploy Function
        if: ${{ needs.infra-compute.result == 'success' }}
        uses: azure/CLI@v2
        env:
          FUNCTION_APP_NAME: ${{ steps.pulumi-compute.outputs.functionAppName }}
        with:
          inlineScript: |
            cd $GITHUB_WORKSPACE/infra/compute/function
            func azure functionapp publish $FUNCTION_APP_NAME --javascript

      # Build and Deploy Static Site
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.154.5'
          extended: true

      - name: Install Hugo Helpers
        working-directory: ./src
        run: npm ci

      - name: Build Site
        working-directory: ./src
        run: npm run build

      - name: Deploy Static Site
        uses: azure/CLI@v2
        env:
          STORAGE_ACCOUNT_NAME: ${{ steps.pulumi-publishing.outputs.storageAccountName }}
        with:
          inlineScript: |
            az storage blob sync --account-name $STORAGE_ACCOUNT_NAME --container '$web' --source $GITHUB_WORKSPACE/src/public
