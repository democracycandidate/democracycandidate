{{ define "main" }}
  {{ partial "page-header" . }}

  <section class="section-sm">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10">
          
          <!-- Instructions -->
          {{ .Page.RenderString "{{< contribution-requirements >}}" | safeHTML }}

          <!-- Form -->
          <form id="candidate-form" class="row g-4">
            
            <!-- Pledge Acknowledgment -->
            <div class="col-12">
              <div class="rounded border border-border p-4 dark:border-darkmode-border">
                <label class="form-check-label flex items-start">
                  <input type="checkbox" id="pledge-checkbox" required class="form-check-input mt-1 mr-3">
                  <span>The candidate agrees to the <a href="/running/pledge" target="_blank" class="text-primary">pro-democracy pledge</a> <span class="text-red-600">*</span></span>
                </label>
              </div>
            </div>

            <!-- Candidate Information Section -->
            <div class="col-12">
              <h3 class="h4">Candidate Information</h3>
            </div>

            <div class="md:col-6 col-12">
              <label for="candidate-name" class="form-label">Candidate Name <span class="text-red-600">*</span></label>
              <input type="text" id="candidate-name" class="form-input" required>
            </div>

            <div class="md:col-6 col-12">
              <label for="position-title" class="form-label">Office/Position Title <span class="text-red-600">*</span></label>
              <input type="text" id="position-title" class="form-input" placeholder="e.g., School Board Member" required>
              <small class="form-text">The position you're running for</small>
            </div>

            <div class="md:col-6 col-12">
              <label for="party" class="form-label">Party Affiliation <span class="text-red-600">*</span></label>
              <input type="text" id="party" class="form-input" placeholder="e.g., Independent, Democratic, Republican" required>
            </div>

            <div class="md:col-6 col-12">
              <label for="election-date" class="form-label">Election Date <span class="text-red-600">*</span></label>
              <input type="date" id="election-date" class="form-input" required>
            </div>

            <!-- Categorization Section -->
            <div class="col-12 mt-6">
              <h3 class="h4">Categorization</h3>
            </div>

            <div class="md:col-6 col-12">
              <label for="category" class="form-label">Category <span class="text-red-600">*</span></label>
              <select id="category" class="form-select" required>
                <option value="">Select category...</option>
                <option value="School Board">School Board</option>
                <option value="Library Board">Library Board</option>
                <option value="Park District">Park District</option>
                <option value="Township">Township</option>
                <option value="Village">Village</option>
                <option value="Forest Preserve">Forest Preserve</option>
                <option value="Other Local">Other Local</option>
              </select>
            </div>

            <div class="md:col-6 col-12">
              <label for="state" class="form-label">State <span class="text-red-600">*</span></label>
              <select id="state" class="form-select" required>
                <option value="">Select state...</option>
                <option value="Alabama">Alabama</option>
                <option value="Alaska">Alaska</option>
                <option value="Arizona">Arizona</option>
                <option value="Arkansas">Arkansas</option>
                <option value="California">California</option>
                <option value="Colorado">Colorado</option>
                <option value="Connecticut">Connecticut</option>
                <option value="Delaware">Delaware</option>
                <option value="Florida">Florida</option>
                <option value="Georgia">Georgia</option>
                <option value="Hawaii">Hawaii</option>
                <option value="Idaho">Idaho</option>
                <option value="Illinois">Illinois</option>
                <option value="Indiana">Indiana</option>
                <option value="Iowa">Iowa</option>
                <option value="Kansas">Kansas</option>
                <option value="Kentucky">Kentucky</option>
                <option value="Louisiana">Louisiana</option>
                <option value="Maine">Maine</option>
                <option value="Maryland">Maryland</option>
                <option value="Massachusetts">Massachusetts</option>
                <option value="Michigan">Michigan</option>
                <option value="Minnesota">Minnesota</option>
                <option value="Mississippi">Mississippi</option>
                <option value="Missouri">Missouri</option>
                <option value="Montana">Montana</option>
                <option value="Nebraska">Nebraska</option>
                <option value="Nevada">Nevada</option>
                <option value="New Hampshire">New Hampshire</option>
                <option value="New Jersey">New Jersey</option>
                <option value="New Mexico">New Mexico</option>
                <option value="New York">New York</option>
                <option value="North Carolina">North Carolina</option>
                <option value="North Dakota">North Dakota</option>
                <option value="Ohio">Ohio</option>
                <option value="Oklahoma">Oklahoma</option>
                <option value="Oregon">Oregon</option>
                <option value="Pennsylvania">Pennsylvania</option>
                <option value="Rhode Island">Rhode Island</option>
                <option value="South Carolina">South Carolina</option>
                <option value="South Dakota">South Dakota</option>
                <option value="Tennessee">Tennessee</option>
                <option value="Texas">Texas</option>
                <option value="Utah">Utah</option>
                <option value="Vermont">Vermont</option>
                <option value="Virginia">Virginia</option>
                <option value="Washington">Washington</option>
                <option value="West Virginia">West Virginia</option>
                <option value="Wisconsin">Wisconsin</option>
                <option value="Wyoming">Wyoming</option>
              </select>
            </div>

            <div class="col-12">
              <label for="tags" class="form-label">Location Tags <span class="text-red-600">*</span></label>
              
              <!-- Tag Input Container -->
              <div id="tag-input-container" class="form-input flex flex-wrap gap-2 items-center min-h-[45px] py-1.5 focus-within:ring-1 focus-within:border-primary">
                <div id="tags-list" class="flex flex-wrap gap-2"></div>
                <input type="text" id="tag-entry" class="bg-transparent border-none outline-none flex-grow min-w-[150px] text-inherit placeholder-gray-400 p-0 focus:ring-0" placeholder="Type tag & press Enter...">
              </div>
              
              <small class="form-text mt-1 block text-gray-500">
                Tags help group candidates (e.g. "School Board", "District 15") and generate unique pages like <code class="bg-gray-100 px-1 rounded text-xs">/tags/bloomingdale-il/</code>. Essential for QR codes, regional groupings, and slates.
              </small>
            </div>

            <!-- Content Section -->
            <div class="col-12 mt-6">
              <h3 class="h4">Biography Content</h3>
            </div>

            <div class="col-12">
              <label for="about" class="form-label">Short Bio (for card display) <span class="text-red-600">*</span></label>
              <textarea id="about" class="form-input" rows="4" required maxlength="500" placeholder="A brief summary (200-500 characters) about yourself and why you're running"></textarea>
              <small class="form-text"><span id="about-count">0</span>/500 characters</small>
            </div>

            <div class="col-12">
              <label for="content-editor" class="form-label">Full Biography <span class="text-red-600">*</span></label>
              <small class="form-text mb-2 block">Use the editor below to write your full biography. Include sections like Policy, Experience, Collaboration, etc.</small>
              <textarea id="content-editor"></textarea>
            </div>

            <!-- Images Section -->
            <div class="col-12 mt-6">
              <h3 class="h4">Photos</h3>
            </div>

            <div class="md:col-6 col-12">
              <label for="avatar-upload" class="form-label">Profile Photo (Avatar) <span class="text-red-600">*</span></label>
              <input type="file" id="avatar-upload" class="form-input" accept="image/*" required>
              <small class="form-text">Square photo, max 5MB</small>
              <input type="hidden" id="avatar-data">
              <div id="avatar-preview" class="mt-3 hidden">
                <img src="" alt="Avatar preview" class="max-h-48 rounded">
              </div>
            </div>

            <div class="md:col-6 col-12">
              <label for="title-upload" class="form-label">Title/Hero Image (Optional)</label>
              <input type="file" id="title-upload" class="form-input" accept="image/*">
              <small class="form-text">Wide banner image, max 5MB</small>
              <input type="hidden" id="title-data">
              <div id="title-preview" class="mt-3 hidden">
                <img src="" alt="Title preview" class="max-h-48 rounded">
              </div>
            </div>

            <!-- Contact Information Section -->
            <div class="col-12 mt-6">
              <h3 class="h4">Contact Information (Private)</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400">This information will be stored securely and never published. We use it to verify your submission.</p>
            </div>

            <div class="md:col-6 col-12">
              <label for="contact-email" class="form-label">Email Address <span class="text-red-600">*</span></label>
              <input type="email" id="contact-email" class="form-input" required>
            </div>

            <div class="md:col-6 col-12">
              <label for="contact-phone" class="form-label">Phone Number (Optional)</label>
              <input type="tel" id="contact-phone" class="form-input">
            </div>

            <div class="col-12">
              <label for="contact-notes" class="form-label">Additional Notes (Optional)</label>
              <textarea id="contact-notes" class="form-input" rows="3" placeholder="Any additional context or verification details"></textarea>
            </div>

            <!-- Turnstile & Submit -->
            <div class="col-12 mt-6">
              <div class="cf-turnstile mb-4" data-sitekey="{{ .Site.Params.turnstile.site_key }}"></div>
              <button type="submit" id="submit-btn" class="btn btn-primary" disabled>
                <span id="submit-text">Submit Candidate Profile</span>
                <span id="submit-spinner" class="hidden">
                  <svg class="inline h-4 w-4 animate-spin" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Submitting...
                </span>
              </button>
            </div>

          </form>

          <!-- Success/Error Messages -->
          <div id="success-message" class="mt-6 hidden rounded-lg bg-green-100 p-6 dark:bg-green-900">
            <h3 class="h5 mb-2 text-green-800 dark:text-green-100">Submission Successful!</h3>
            <p class="mb-2 text-green-700 dark:text-green-200">Your candidate profile has been submitted. A pull request has been created for review.</p>
            <p class="mb-2"><strong>PR Link:</strong> <a id="pr-link" href="#" target="_blank" class="text-green-600 underline dark:text-green-300"></a></p>
            <p class="text-sm text-green-600 dark:text-green-300">Correlation ID: <code id="correlation-id" class="rounded bg-green-200 px-2 py-1 dark:bg-green-800"></code></p>
          </div>

          <div id="error-message" class="mt-6 hidden rounded-lg bg-red-100 p-6 dark:bg-red-900">
            <h3 class="h5 mb-2 text-red-800 dark:text-red-100">Submission Failed</h3>
            <p id="error-text" class="text-red-700 dark:text-red-200"></p>
            <ul id="error-list" class="mt-2 list-disc pl-5 text-red-600 dark:text-red-300"></ul>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- Include EasyMDE CSS and JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@latest/dist/easymde.min.css">
  <script src="https://cdn.jsdelivr.net/npm/easymde@latest/dist/easymde.min.js"></script>
  
  <!-- Turnstile Script -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <!-- Form Handler Script -->
  <script>
    // Initialize EasyMDE
    const easyMDE = new EasyMDE({
      element: document.getElementById('content-editor'),
      placeholder: 'Write your biography here...',
      spellChecker: true,
      autosave: {
        enabled: true,
        uniqueId: 'candidate-submission',
        delay: 5000,
      },
      toolbar: ['bold', 'italic', 'heading', '|', 'unordered-list', 'ordered-list', '|', 'link', 'preview', 'side-by-side', 'fullscreen', 'guide'],
      initialValue: `### Policy

[Describe your policy positions and what you stand for]

### Experience

[Share your relevant experience and qualifications]

### Collaboration

[Explain how you work with others and build consensus]`
    });

    // Character counter for about field
    const aboutField = document.getElementById('about');
    const aboutCount = document.getElementById('about-count');
    aboutField.addEventListener('input', () => {
      aboutCount.textContent = aboutField.value.length;
    });

    // Enable submit button when pledge is checked
    const pledgeCheckbox = document.getElementById('pledge-checkbox');
    const submitBtn = document.getElementById('submit-btn');
    pledgeCheckbox.addEventListener('change', () => {
      submitBtn.disabled = !pledgeCheckbox.checked;
    });

    // Image upload handlers
    function handleImageUpload(inputId, dataId, previewId) {
      const input = document.getElementById(inputId);
      const dataField = document.getElementById(dataId);
      const preview = document.getElementById(previewId);
      
      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.match('image.*')) {
          alert('Please upload an image file');
          input.value = '';
          return;
        }
        
        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image must be under 5MB');
          input.value = '';
          return;
        }
        
        // Convert to base64
        const reader = new FileReader();
        reader.onload = (event) => {
          dataField.value = event.target.result;
          preview.querySelector('img').src = event.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      });
    }

    handleImageUpload('avatar-upload', 'avatar-data', 'avatar-preview');
    handleImageUpload('title-upload', 'title-data', 'title-preview');

    // Tag Manager Logic
    const tagEntry = document.getElementById('tag-entry');
    const tagsList = document.getElementById('tags-list');
    let currentTags = [];

    function renderTags() {
      tagsList.innerHTML = '';
      currentTags.forEach((tag, index) => {
        const tagEl = document.createElement('div');
        tagEl.className = 'bg-primary/10 text-primary px-2 py-1 rounded text-sm flex items-center gap-1';
        tagEl.innerHTML = `
          <span>${tag}</span>
          <button type="button" class="hover:text-red-500 focus:outline-none" onclick="removeTag(${index})">
            &times;
          </button>
        `;
        tagsList.appendChild(tagEl);
      });
    }

    window.removeTag = (index) => {
      currentTags.splice(index, 1);
      renderTags();
    };

    tagEntry.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const val = tagEntry.value.trim();
        if (val && !currentTags.includes(val)) {
          currentTags.push(val);
          tagEntry.value = '';
          renderTags();
        } else if (currentTags.includes(val)) {
          tagEntry.value = ''; // Clear duplicate attempt
        }
      }
      if (e.key === 'Backspace' && !tagEntry.value && currentTags.length > 0) {
        currentTags.pop();
        renderTags();
      }
    });

    // Form submission
    const form = document.getElementById('candidate-form');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Disable submit button and show spinner
      submitBtn.disabled = true;
      document.getElementById('submit-text').classList.add('hidden');
      document.getElementById('submit-spinner').classList.remove('hidden');
      
      // Hide previous messages
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      
      try {
        // Get Turnstile token
        const turnstileToken = turnstile.getResponse();
        if (!turnstileToken) {
          throw new Error('Please complete the security check');
        }
        
        // Build categories array
        const category = document.getElementById('category').value;
        const state = document.getElementById('state').value;
        const categories = [category, state];
        
        // Build tags array
        const tags = currentTags;
        if (tags.length === 0) {
            throw new Error('Please add at least one location tag');
        }
        
        // Build payload
        const payload = {
          candidate: document.getElementById('candidate-name').value,
          title: document.getElementById('position-title').value,
          party: document.getElementById('party').value,
          election_date: document.getElementById('election-date').value,
          categories: categories,
          tags: tags,
          about: document.getElementById('about').value,
          content: easyMDE.value(),
          avatarImage: document.getElementById('avatar-data').value,
          titleImage: document.getElementById('title-data').value || undefined,
          contactEmail: document.getElementById('contact-email').value,
          contactPhone: document.getElementById('contact-phone').value || undefined,
          contactNotes: document.getElementById('contact-notes').value || undefined,
          turnstileToken: turnstileToken
        };
        
        // Submit to Azure Function
        const response = await fetch('https://democracycandidate-prod-funcccd8ebf4.azurewebsites.net/api/submitCandidate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Show success message
          document.getElementById('pr-link').href = result.pullRequestUrl;
          document.getElementById('pr-link').textContent = result.pullRequestUrl;
          document.getElementById('correlation-id').textContent = result.correlationId;
          successMessage.classList.remove('hidden');
          
          // Reset form
          form.reset();
          currentTags = []; // NEW
          renderTags(); // NEW
          easyMDE.value('');
          document.getElementById('avatar-preview').classList.add('hidden');
          document.getElementById('title-preview').classList.add('hidden');
          turnstile.reset();
          
          // Scroll to success message
          successMessage.scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error(result.message || 'Submission failed');
        }
        
      } catch (error) {
        // Show error message
        document.getElementById('error-text').textContent = error.message;
        
        // Show error details if available
        const errorList = document.getElementById('error-list');
        errorList.innerHTML = '';
        if (error.errors && Array.isArray(error.errors)) {
          error.errors.forEach(err => {
            const li = document.createElement('li');
            li.textContent = err;
            errorList.appendChild(li);
          });
        }
        
        errorMessage.classList.remove('hidden');
        errorMessage.scrollIntoView({ behavior: 'smooth' });
        
        // Reset Turnstile
        turnstile.reset();
        
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        document.getElementById('submit-text').classList.remove('hidden');
        document.getElementById('submit-spinner').classList.add('hidden');
      }
    });
  </script>

{{ end }}
